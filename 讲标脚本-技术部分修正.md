## 可行性研究
  - 首先我先介绍下鸿蒙的发展历程。
      - 2017 年华为发布了鸿蒙1.0内核， 主要是内核的技术验证(其实在特朗普上任的 2016 年开始，中国贸易摩擦就开始了，不过华为目前还没有受到直接到针对性的制裁)。
      - 2018 年华为发布鸿蒙 2.0内核，并公布了对应的开源版本。重点是TEE（可信环境引擎），用于比如生物验证等对安全要求高的环境（同年，美国对华为的制裁骤然加速，年底孟晚舟被捕）。
        - 到目前为止，华为其实一直都是停留在内核层面，尚未有一个完整的系统。
      - 2019 年，鸿蒙 1.0正式实装在华为智慧屏上，基于之前的开源版本打造， 重点是底层的特性。聚焦微内核TEE 的验证使用，方舟引擎，可确定性延迟（用于对延迟非常敏感的工业领域，比如光电控制，远程手术）。面向应用层的多终端 IDE 开始 Beta 测试（可以同时支持手机，手表，平板）。
      - 2020 年，鸿蒙 2.0开始大规模实装在手机上，正式发布了多终端 IDE，开始提供自研的应用层框架，基于方舟引擎提供的多语言统一编译能力，从此可以开发普通用户最常接触的 App。另外基于方舟图形引擎，重点提高了图形性能，并满足车规要求。
        - 也正是在这一年，华为发布了制裁前，可以被台积电代工的全球首款 5nm 芯片：麒麟 9000，搭载于 Mate40 系列，这个系列是最后一个搭载 EMUI 11 的手机，并可以 OTA 升级到鸿蒙 2.0
      - 2022 年, 时隔两年后，鸿蒙 3.0重点进行了软硬件协同的适配，包含文件系统加速，新的分布式架构，高性能的 IPC 设计。
        - 也是这一年华为在制裁后，首次发布了自己的新手机：mate50 系列，成为华为手机业务重启的一个重要信号。
      - 2023 年，鸿蒙 4.0 提供了盘古大模型，用于AI 加速，新的鸿蒙内核，以及应用层全新设计的 Ark Engine, 鸿蒙正式确认 ArkTS 成为应用层指定的开发语言。
        - 也是这一年的 8 月份，华为发布了搭载自研麒麟9000s 的 Mate60 系列手机，并正式支持了5G 通信，宣布了华为突破在国制裁，取得手机业务全栈硬件自主权。
        - 至此，华为所有的鸿蒙系统，其实都是双内核的，也就是支持 基于 AOSP 的安卓，也支持华为的 DevEco 开发的 App。
      - 2024 年，华为正式宣布Harmony OS Next，中文名鸿蒙星河版。正式宣布取消对AOSP安卓的兼容，进化为纯血鸿蒙。从系统到应用层，完全由华为全栈自研。预计将于2024年底正式投入使用。
        - 这标志着，华为从软件和硬件层面，都将彻底独立，不再受到美国制裁的阻塞性影响。
        - 在这个过程中，华为有一个不变的点：1+8+N 的支持，其中 1 指的是手机，8 指的是手表，平板，电视， 车机，耳机等 8 款设备。N 指的是面向用户的多种需求，比如娱乐游戏，智慧出行，智能家居，运动健康等等。
        - 未来华为也将继续围绕这个战略，不断进化，更加贴合用户需求，成为用户更加智能化的助理。
  - 最新的纯血鸿蒙提供如下完整的底层支持，包含：
      - 用于用户开发的 DevEco IDE，它集成了云支持，测试框架，满足从开发到测试验证到最终上线的全链路的支持
      - 用于构建应用的 Ark 系列，包含开发语言 ArkTS，编译器 ArkCompiler，UI 框架 ArkUI
      - 系统架构从上到下，大致分为三大块，
        - 最上面是应用层，包含我们常用的系统应用，比如设置，应用商店，以及三方开发的 app。
        - 中间是系统框架，给应用层提供诸如定位，AI，安全认证等能力。
        - 底层是系统内核，是操作系统和硬件对接的部分。
         - 提供KAL：kernel adaptioin layer，用于内核和硬件之间的抽象层，满足对接不同的手机，手表，平板等硬件
         - HDF：OpenHarmony Driver Foundation，用于提供鸿蒙平台的驱动的精细化管理，比如驱动的按需加载，驱动的多平台配置。
         - Driver Sub-system：用于华为提供统一的外围设备操作 API，可以简化驱动开发。相对于 HDF，推荐在硬件资源有限的嵌入式场景，使用 Driver 子系统来开发。
      - 通过这些基础设施，华为生态提供了三大能力：
          - 一次开发，多端部署。在 DevEco 的帮助下，我们可以针对手机，平板，手表等多终端写代码。完成多端测试验证，上线部署。
            - 这里的一次开发，目前还无法做到一套代码多短运行，仍然需要针对特定端适配特定的代码。当然可以复用部分代码。
          - 可分可合 DevEco 推荐的多模块模式下，多个终端可以任何组合 hap/hap 构建产物，完成多端的代码复用。
          - 自由流转包含两个场景，一个是多设备的数据流转。比如头脑风暴在手机上记录草稿，然后回去草稿会流转到电脑上继续整理。另外一个是多设备之间的协作，比如可以把手机作为平板的摄像头进行人脸识别的验证。
          - 统一生态，原生智能。则是华为通过 Ark 框架提供了系统框架层的统一支持，通过系统提供的 AI 等能力，用户使用的时间越久，鸿蒙设备对你的了解和配合就越默契。比如系统会习惯你的作息，来平衡设备的充电和性能优化时间；系统会习惯你的操作，从而进行针对性加速；
  - 目前鸿蒙的统一的框架如下：
      - 首先最下面是多种形态的设备，包含手表，手机，平板，PC 等等，他们均运行鸿蒙系统，通过鸿蒙提供的系统服务，对应用层进行统一的支持。
      - 目前华为的鸿蒙和开源鸿蒙是一个互补的关系，鸿蒙本身是闭源的，华为投入实现的能力，会反哺开源鸿蒙；同时开源鸿蒙社区的工作成果，也会合并到华为的鸿蒙里面。实现共同成就。
      - 华为统一框架下，对各种开发框架进行了一视同仁的支持，包含原生的 ArkUI，已经三方的诸如 Flutter 等开发框架。从而方便合作生态企业自由选择。
  - 目前，华为和合作企业正在推进很多 app 登录纯血鸿蒙：
      - 从 2023 年八月份，华为 Mate60 发布开始，基于预览版华为已经开始对接很多头部公司
      - 2024 年一月，华为正式公布了鸿蒙星河版，并宣布年底商用，会上公布200+的 App 正式宣布接入鸿蒙。比如高德地图，BiliBili 等等。另外有头部 5000+正在路上
      - 根据华为的计划，2024 年 6 月，鸿蒙将开始先锋 Beta 测试，部分收到邀请的用户可以开始体验 Harmony OS Next，8 月份进行全量的 Beta 测试，Mate60及后续的手机可以优先体验测试版。年底正式商用
  - 具体而言，把BMW app 迁移到鸿蒙，我们有如下考量：
      - 首先是原因。在BMW目前的安卓平台中，有很大一部分是华为用户，这部分用户作为华为的粉丝，未来也很可能继续使用华为的手机。那么当未来的鸿蒙不再兼容安卓后，BMW 对这些用户在新的平台上继续提供服务，体现了宝马对用户的负责。
      - 第二点是时机。考虑到华为的商业计划，鸿蒙将在今年底商用，我们综合考虑了开发，测试，发布的全流程，预计在 2025 年的年初或者更早完成对鸿蒙的支持。
      - 第三点是任务拆分。我们打算从一下几个大的方面去落实对鸿蒙的支持：
          - 首先是可行性分析，我们将重点评估 BMW 现在使用的 Flutter 技术栈在鸿蒙上的可行性，然后进行和原生开发技术栈进行对比。
          - 然后是组建团队，对着两项技术做深度调研并给出调研结论。
          - 接下来进入开发和测试工作。
          - 最后发布上架，并持续维护。
  - 我们对 Flutter 和鸿蒙原生开发做了一个多维度的比对：
      - 在鸿蒙系统上，Flutter 作为 UI 框架，地位类似于原生的 ArkUI。二者都是声明式 UI 框架。后者也明确借鉴了前者的开发理念。
      - 具体的图形引擎，Flutter 使用 Impeller 或者 Skia 来渲染，而原生使用华为研究数年的方舟引擎。
      - 在底层的图形 API 方面，二者使用了相同的接口，也就是 Open GL或者 Vulkan，这两者是并存的，使用哪一个，取决于 Flutter， ArkUI以及系统内置的版本。
      - 在运行态方面，鸿蒙原生基于方舟编译器，使用 JIT 编译为机器码，而 Flutter 使用 AOT 提前编译为机器码。Flutter 相对更加省电。
      - 在图形性能方面，根据我们对测试版鸿蒙自带的系统应用和 Flutter 测试 demo 对比，Flutter 要更胜一筹，原生这边随着华为的持续打磨，相信未来会更好，更稳定。
      - 安全方面，原生直接对接了鸿蒙的系统安全能力，而 Flutter 同样可以使用插件来复用系统的安全能力，所以本质是一样的。
      - 更新频率方面，原生类似 iOS/Android 的策略，一年更新一个API，Flutter 目前由华为维护，也是一年打算更新一个版本，未来鸿蒙影响力变大获得 google 官方支持后，更新还会更频繁，大概一年 4 次。
      - 多平台 UI 一致性方面，目前原生处于 beta 测试状态，需要磨合。Flutter 这边则可以完全复用 UI代码，做到 iOS/Android/鸿蒙多端一致。
      - MVP0 功能集合：原生因为要从零开发，支持的功能较少。Flutter 因为复用了大部分代码，功能会多很多。
      - 代码复用层面，鸿蒙原生因为开发语言都换了，代码复用度接近于零。而 Flutter 所有的 Dart 代码都可以复用，在整个 app 的代码中占比大概超过 9 成。
      - 架构层面，二者都是多模块的分层架构，是一致的。
      - 可能阻塞方面：原生是华为官方支持，阻塞可能很小。Flutter 这边由华为和阿里巴巴等合作伙伴共同落地，阻塞可能也很小。
      - 开发体验：原生有完整的 IDE 支持，具有较好的调试开发体验。Flutter 这边的支持还不太完善，变动的方法是借助安卓来调试 Dart 代码， 借助原生来调试Plugin 代码。
      - 未来愿景：
          - 随着鸿蒙影响力逐渐扩大，相信鸿蒙终将跻身世界三大移动操作系统，开发工具等支持将越来越完善。
          - Flutter 这边，短期内将获得华为和合作伙伴的支持，长期来看随着鸿蒙系统的影响力越来越大，终将获得 Flutter 官方的支持。
  - 总结而言：
      - 鸿蒙原生的优势是：拥有完善的开发和调试工具链，ArkUI 内置了对多种屏幕形态的响应式支持，以及来自华为官方的大力支持。
      - 鸿蒙原生的劣势是：代码复用度接近零，需要巨大重新设计，重新开发的成本。另外后续维护鸿蒙原生和现有的 Flutter 两套工程，也将带来较大的成本开销。
      - Flutter 的优势是：总体工程九成以上的代码复用度，媲美原生的性能，极高的多平台功能一致性。以及维护一套 Flutter 巨大的成本优势。
      - Flutter 的劣势是：当前 Flutter 是华为和阿里巴巴等合作维护的一个分支，还没有获得 Flutter 官方的支持。（未来随着鸿蒙的影响力变大，将很有可能获得来自 google 的支持）
  - 参考之前 BMW 整个数字技术在 iOS/Android 端的支持，我们梳理了预计需要提供鸿蒙支持的范围：
      - 在之前的宝马数字化战略当中，集团现有的移动服务和产品，以及所有的NOW服务（ChargeNow，ReachNow，ParkNow，DriveNow等）整合在一起，形成完整的数字化生态。让用户仅使用唯一的BMW ID，就可以享受BMW提供的所有产品和全渠道的数字体验服务。这里的用户数字体验不仅仅是使用最新技术，而是需要给客户提供个性化的、适应不同情景的服务与信息。它具体包含了My Car 车相关的、My Life 数字生活相关的、My Journey旅途相关的，以及中国市场独有的一些服务。
      - 在实现这些服务过程中，OMC作为BMW的所有后端服务的集成平台，给不同的前端应用提供了统一的接口调用。针对不同的My Car、My Life、My Journey等Feature，Service Owner从用户需求角度对业务做出分析t和决策，按照业务价值排序和计划
      - 那么在新增鸿蒙平台的支持后，迁移的工作围绕的是手机，手表，和 OMC 服务端。其中的大头是手机。
  - 目前 BMW app 的整体架构如图：
      - 周边是各个独立的模块，如Joy_UI, Atlas, Car_connection等等，中间是通用的 platform sdk 模块，下面是各个业务的 feature module，这些都是基于 flutter 实现。
      - 右边是我们的 OMC 网关，用于和服务端进行通信。
      - 顶部是和特定的平台进行集成的工程配置。包含符合特定平台格式的 app shell，作为承载启动的容器，中间是 main 启动流程，左边是三个移动操作系统平台。而本次的工作就是新增鸿蒙的平台。
  - 针对 Flutter 的实现，我们也列出了一个图，来简单直观的呈现 Flutter on 鸿蒙的支持：
      - 首先，我们会 100% 复用现在的 Flutter 代码，也就是用 Dart 书写的代码。
      - 再此基础上，添加针对鸿蒙的 Plugin，用来沟通 Dart 和原生的 ArkTs 语言。
      - 最后，我们把这些装在一个针对鸿蒙的 App Shell里面, 从而确保符合鸿蒙的 app 安装格式。
      - 至此，我们的 BMW app 就可以运行在纯血鸿蒙系统上。
  - 在质量保证层面，开发的重点是单元测试：
    - 包含两个维度，一个是常规的单元测试，另外一个是 UI 测试。
    - 单元测试对于 Dart 层面可以做到完全的复用。在鸿蒙原生层面，借助JsUnit等框架
    - UI 测试方面，Flutter 对应 UI 可以完全的复用，原生 UI 可以借助鸿蒙的UiTest来完成。
    - 在测试的维度方面，我们从测试 case，到数据的 mock/fake，到测试开始前的配置，测试当中的单台/多台分布式验证等等，到测试退出后的清理工作，确保测试case互相无干扰，稳定。
  - 为了验证 Flutter 可行度，我们在技术层面拆分了6个验证的维度：
      - 编译验证，确保 Flutter 可以和原生 Shell 一起构建符合鸿蒙格式的 app
      - 运行验证，确保编译的产物可以运行在鸿蒙星河版上
      - Dart 网络 IO 验证，确保端到端的网络调用是正常的
      - Dart 磁盘 IO 验证，我们将结合 BMW 使用的 Bloc 框架使用 HIVE 框架，确保 Dart IO在磁盘操作上正常
      - 插件验证，我们将验证插件中联通 Dart 和 ArkTS 的三个 channel，分别是 MethodChannel，EventChannel 和标准编码 Channel。
      - 最后是 UI 渲染验证，我们将基于 Joy_UI,确保图片/文字等基本渲染正常，并确保阴影/纹理等高级渲染正常。
      - 以上六个维度，全面验证了 Flutter 引擎和 鸿蒙系统 的契合程度，从而确保我们坐落于引擎之上的业务运行正常。
  - 目前我们对以上的验证已经有了实际的操作，总结如下：
      - 技术方面，我们对以上 6 个维度都进行了测试，确认了 Flutter 可以在鸿蒙系统上正常的运行。
      - 安全层面，Flutter 使用插件沟通原生，可以复用鸿蒙系统的所有安全能力。
      - 平台特性，Flutter 通过插件可以使用系统所有的能力。
      - 性能方面：Flutter 基于 AOT 编译，提前编译为机器码，和 GPU 直接对接，没有系统额外的中间转换，拥有很高的性能。
      - 官方支持：目前 Flutter 处于华为和阿里巴巴等社区的共同支持下，未来随着鸿蒙跻身世界三大移动操作系统，很有可能会获取 Flutter 官方的支持。
  - 我们罗列了一个简单的flutter with 鸿蒙的相对于 iOS/Android 的对比图，来形象的展示我们需要的工作：
    - 最左边是 Dart 代码，这是所有平台通用的，也是我们业务代码最多的部分。
    - 中间是引擎，也就是 Flutter 的渲染引擎，大部分是 C++写的。他本身维护了一个注册机制，用来沟通同一个 Method 的 Dart 侧和原生侧的通信。
    - 最右边是原生侧，之前我们的实现主要是安卓和 iOS，那么针对鸿蒙我们要做的工作，就是新增原生代码，来向引擎注册鸿蒙的 method channel，从而实现对鸿蒙原生功能的调用。
  - 具体开发操作而言，我们罗列了一个流程图，来线性的说明整个操作的流程：
    - 首先是安装鸿蒙的 IDE，叫 DevEco
    - 然后是安装适配鸿蒙的 Flutter SDK
    - 然后执行 Flutter 创建插件的命令。
    - 然后执行 pub get，来同步依赖，之后执行一次构建，来确保所有的临时构建文件都存在。
    - 这时候我们可以使用 DevEco 打开插件的 ohos 目录，执行签名配置，添加原生代码，并能够运行到真机执行调试。
  - 那么未来，基于插件和原生之间沟通的这个能力，我们还可以做很多鸿蒙专属的功能：
    - 比如鸿蒙的 AI 能力，可以在很多场景增加用户的效率，比如基于 AI 的文字识别，基于 AI 的车的识别，那么我们可以通过插件来调用这个能力。
    - 比如鸿蒙的分布式存储，我们可以通过插件，释放未来 App 和手表间的数据同步能力。
    - 比如可信环境计算，我们可以利用华为硬件级别的安全保障，让我们对敏感数据的处理更加放心，对用户的身份识别更加可靠。
    - 我相信未来，我们可以结合 Flutter 跨端渲染多端UI一致的优点，在占比最多的 UI 代码上做到多平台复用来做到多平台功能对齐，同时通过插件可以使用较少的 effort 做到对鸿蒙平台特色能力的使用。不断的提高鸿蒙用户的体验。
